var code, compiler, filename, fs, js, m, mainModule, path, repl, vm;

fs = require('fs');

path = require('path');

repl = require('repl');

vm = require('vm');

m = require('module');

compiler = require('./compiler');

filename = process.argv[2];

if (filename != null) {
  require('./register');
  mainModule = require.main;
  mainModule.filename = filename = fs.realpathSync(filename);
  mainModule.moduleCache && (mainModule.moduleCache = {});
  mainModule.paths = m._nodeModulePaths(path.dirname(filename));
  code = fs.readFileSync(filename, 'utf8');
  js = compiler.compile(code);
  mainModule._compile(js, mainModule.filename);
} else {
  repl.start({
    prompt: 'cirru-script> ',
    "eval": function(input, context, filename, cb) {
      var err, error;
      code = input.slice(0, -1);
      try {
        js = compiler.compile(code);
        return cb(null, vm.runInContext(js, context));
      } catch (error) {
        err = error;
        return cb(err);
      }
    }
  });
}
