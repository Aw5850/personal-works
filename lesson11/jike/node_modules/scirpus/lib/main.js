"use strict";

var parser = require("cirru-parser"),
    escodegen = require("escodegen"),
    babel = require("babel-core/browser"),
    operations = require("./operations"),
    req = new XMLHttpRequest(),
    source = document.querySelector("#source"),
    compiled = document.querySelector("#compiled");

require("./layout.css");

req.open("GET", "./examples/cond.cirru");

req.onload = function (res) {
  var code = req.responseText;
  source.value = code;
  tryRender(code);
};

req.send();

var render = function render(code) {
  var ast = parser.pare(code),
      result = operations.transform(ast),
      display = JSON.stringify(result, null, 2);
  console.log("ast:", ast);
  compiled.value = display;
  console.log("result:", display);
  console.log("generated code:");
  console.log(babel.fromAst(result, null, {}).code);
  undefined;
};

var tryRender = function tryRender(code) {
  try {
    render(code);
  } catch (err) {
    var message = err.message,
        stack = err.stack;
    compiled.value = message + "\n\n" + stack;
  }
};

source.addEventListener("input", function (event) {
  tryRender(event.target.value);
});